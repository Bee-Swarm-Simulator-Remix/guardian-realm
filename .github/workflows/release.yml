name: Releases
on:
    push:
        branches:
            - main

jobs:
    build:
        if: github.repository_owner == 'onesoft-sudo'
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v3

            - name: Use Node.js 21.x
              uses: actions/setup-node@v3
              with:
                  node-version: 21.x

            - name: "Install Dependencies"
              run: npm install

            - name: "Install Dev Dependencies"
              run: npm install -D

            - name: "Generate prisma client"
              run: npx prisma generate

            - name: "ESLint"
              run: npm run lint || echo "ESLint Failed"

            - name: "Build"
              run: npm run build --if-present

            - name: "Package the built files"
              run: |
                  mv build sudobot;
                  tar -cvzf sudobot-release.tar.gz sudobot

            - name: Upload Release Artifacts
              uses: actions/upload-artifact@v3
              with:
                  name: sudobot-release
                  path: |
                      ./sudobot-release.tar.gz

    release:
        needs: [build]
        if: github.repository_owner == 'onesoft-sudo'
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v3

            - name: Conventional Changelog Action
              id: changelog
              uses: TriPSs/conventional-changelog-action@v3.15.0
              with:
                  github-token: ${{ secrets.__TOKEN }}
                  version-file: "./package.json"
                  git-user-name: "Conventional Release Action"
                  git-user-email: rakinar2@onesoftnet.eu.org

            - name: Download Release Artifacts
              uses: actions/download-artifact@v2
              with:
                  name: sudobot-release

            - name: Create Release
              id: create_release
              uses: ncipollo/release-action@v1
              if: ${{ steps.changelog.outputs.skipped == 'false' }}
              env:
                  GITHUB_TOKEN: ${{ secrets.__TOKEN }}
              with:
                  tag: ${{ steps.changelog.outputs.tag }}
                  name: ${{ steps.changelog.outputs.tag }}
                  body: ${{ steps.changelog.outputs.clean_changelog }}
                  artifactContentType: application/x-gzip
                  artifacts: ./sudobot-release.tar.gz
